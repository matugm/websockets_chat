<script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
<script src="//code.jquery.com/jquery.js"></script>

<style type="text/css">
	#chatBox {
		border: 2px solid silver;
		border-radius: 4px;
		height: 300px;
		width: 350px;
		overflow: auto;
		padding: 3px;
	}

	#chatInput {
		border: 2px solid silver;
		border-radius: 4px;
		width: 358px;
		font-size: 1.1em;
		padding: 3px;
	}

	#userCount {
		font-size: 12px;
		margin-top: 5px;
	}
</style>

<div id="chatBox">
</div>

<input type="text" id="chatInput" placeholder="Type a message and press enter to send!">

<div id="userCount">
</div>

<script>
	$(document).ready(function() {
		$("#chatInput").focus();
	});

	function escapeHtml(text) {
  	  return text
      	.replace(/&/g, "&amp;")
      	.replace(/</g, "&lt;")
      	.replace(/>/g, "&gt;")
      	.replace(/"/g, "&quot;")
      	.replace(/'/g, "&#039;");
	}

	function isAdminCmd(str) {
		return str.split(" ")[0].charAt(0) == "/";
	}

	document.getElementById("chatInput").addEventListener("keydown", function(e) {
	    if (!e) { var e = window.event; }

	    // Enter key is pressed
	    if (e.keyCode == 13) { sendMessage(); 
	    }
	}, false);

  var socket = io.connect('http://localhost:8020');

  socket.on('server_message', function (data) {
    $("#chatBox").append("[Server] " + data.msg + "<br>");
  });

  socket.on('user_message', function (data) {
  	$("#chatBox").append(data.user + ": "
  		+ escapeHtml(data.msg) + "<br>");

  	$("#chatBox")[0].scrollTop = 9999999;
  });

  socket.on('new_user', function (data) {
  	$("#userCount").text("Connected users: "
  	 + data.count);
  });

  function sendMessage() {
  	var data = $("#chatInput")[0].value;
	$("#chatInput")[0].value = "";

	if (isAdminCmd(data)) {
		socket.emit('admin_cmd', { msg: data });
	} else {
	  	socket.emit('send_message', { msg: data });
	  	addOwnMessage(data);
	}
  }

  function addOwnMessage(data) {
  	$("#chatBox").append("You: "
  		+ escapeHtml(data) + "<br>");

  	$("#chatBox")[0].scrollTop = 99999999;
  }

</script>

